---
title: "Voz Ativa: Respostas até agora"
output:
    html_document:
    df_print: paged
theme: sandstone
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(viridis)
source(here::here("code/lib.R"))
theme_set(theme_report())

knitr::opts_chunk$set(tidy = FALSE,
                      fig.width = 6,
                      fig.height = 5,
                      warning = F,
                      echo = FALSE)

paleta = c("#404E4D",
           "#92DCE5",
           "#938BA1",
           "#2D3142",
           "#F4743B")
```

```{r read, warning=FALSE}

#dados <- read_projectdata()
eleitos <- read_csv("~/Documentos/vozativa-relatorios/data/eleitos.csv", col_types = cols(
        eleito = col_logical()))
dados <- read_csv("~/Documentos/vozativa-relatorios/data/estado-dos-candidatos.csv", 
    col_types = cols(candidaturas = col_double(), 
        eleito = col_logical(), recebeu = col_logical(), 
        respondeu = col_logical(),date_modified = col_datetime(format = ""),
                 date_created = col_datetime(format = "")))

dados <- dados[,-50]

eleitos <- eleitos %>% mutate(nome_urna = ifelse(nome_urna == "CHICO D&APOS;ANGELO", "CHICO D ANGELO", nome_urna))
eleitos <- eleitos %>% select(nome_urna, uf, eleito)
eleitos <- eleitos %>% mutate(nome_urna = toupper(nome_urna)) %>% mutate(uf = toupper(uf))
dados <- dados %>% mutate(nome_urna = toupper(nome_urna)) %>% mutate(uf = toupper(uf))

dados <- dados %>% left_join(eleitos, by = c("nome_urna" = "nome_urna", "uf" = "uf")) 
dados <- dados %>% mutate(eleito = ifelse(is.na(eleito), FALSE, eleito))

dados <- dados[,-c(61:63)]

eleitos <- dados %>% filter(eleito == TRUE)

```

*Atualizado em `r lubridate::now()`*

## Alguns números

```{r}
dados %>% 
    summarise(
        `Total de candidaturas` = n(),
        `Conseguimos email` = sprintf("%d (%.1f%%)", sum(recebeu), 100* sum(recebeu) / n()),
        `Responderam` = sprintf("%d (%.1f%%)", sum(respondeu), 100*sum(respondeu) / sum(recebeu)), 
    ) %>% 
    gather(key = "Número", value = "Valor") %>% 
    knitr::kable()

eleitos %>% 
    summarise(
        `Total de eleitos` = n(),
        `Conseguimos email` = sprintf("%d (%.1f%%)", sum(recebeu), 100* sum(recebeu) / n()),
        `Responderam` = sprintf("%d (%.1f%%)", sum(respondeu), 100*sum(respondeu) / sum(recebeu)), 
    ) %>% 
    gather(key = "Número", value = "Valor") %>% 
    knitr::kable()

```

## Nosso progresso

```{r}
cbPalette <- c("#bcc0c6", "#56B4E9")
 
dados %>% 
    count(respondeu) %>% 
    mutate(Respondeu = if_else(respondeu, "Sim", "Não")) %>% 
    mutate(`Respondeu (%)` = n / sum(n) * 100) %>% 
    ggplot(aes(x = Respondeu, y = `Respondeu (%)`, fill = Respondeu)) + 
    geom_col(width = .2) + 
    theme(legend.position = "None") + 
    labs(title = "No geral") + scale_fill_manual(values = cbPalette)


```



```{r}
  dados %>% 
    filter(!is.na(date_created)) %>% 
    select(date_created) %>% 
    arrange(date_created) %>% 
    mutate(i = 1, 
           Total = cumsum(i)) %>% 
    ggplot(aes(x = date_created, y = Total)) + 
    geom_line(color = "#56B4E9", size = 1.2) + 
    labs(title = "Número de respostas ao longo do tempo", 
         x = "Data", 
         y = "Respostas recebidas") 
```


### Por UF

```{r}
dados %>% 
    count(uf, respondeu) %>% 
    mutate(Respondeu = if_else(respondeu, "Sim", "Não")) %>% 
    group_by(uf) %>% 
    mutate(`Respondeu (%)` = n / sum(n) * 100, 
           sucesso = min(`Respondeu (%)`)) %>% 
    ggplot(aes(x = reorder(uf, sucesso), y = `Respondeu (%)`, fill = Respondeu)) + 
    geom_col(position = "stack") + 
    coord_flip() + 
    labs(
        x = "",
        title = "Respostas por UF (em %)"
    ) + scale_fill_manual(values = cbPalette)

eleitos %>% 
    count(uf, respondeu) %>% 
    mutate(Respondeu = if_else(respondeu, "Sim", "Não")) %>% 
    group_by(uf) %>% 
    mutate(`Respondeu (%)` = n / sum(n) * 100, 
           sucesso = ifelse(respondeu == TRUE, min(`Respondeu (%)`), 0)) %>% 
    ggplot(aes(x = reorder(uf, sucesso), y = `Respondeu (%)`, fill = Respondeu)) + 
    geom_col(position = "stack") + 
    coord_flip() + 
    labs(
        x = "",
        title = "Respostas dos eleitos por UF (em %)"
    ) + scale_fill_manual(values = cbPalette)

```

```{r}
options(scipen = 999)
dados %>% 
    count(uf, respondeu) %>% 
    mutate(Respondeu = if_else(respondeu, "Sim", "Não")) %>%
    mutate(countsim = ifelse(respondeu, n, 0)) %>% 
    ggplot(aes(x = reorder(uf, countsim), y = n, fill = Respondeu)) + 
    geom_col(position = "stack") + 
    coord_flip() + 
    labs(
        x = "",
        title = "Respostas por UF (em absoluto)",
        y = "Quantidade de candidaturas"
    ) + scale_fill_manual(values = cbPalette)

eleitos %>%  
    count(uf, respondeu) %>% group_by(uf) %>% mutate(total = sum(n)) %>% ungroup() %>% 
    mutate(Respondeu = if_else(respondeu, "Sim", "Não")) %>% 
    mutate(countsim = ifelse(respondeu, n, 0)) %>% 
    ggplot(aes(x = reorder(uf, countsim), y = n, fill = Respondeu)) + 
    geom_col(position = "stack") + 
    coord_flip() + 
    labs(
        x = "",
        title = "Respostas dos eleitos por UF (em absoluto)",
        y = "Quantidade de candidaturas"
    ) + scale_fill_manual(values = cbPalette)
```

### Por partido

```{r}
dados %>% 
    count(sg_partido, respondeu) %>% 
    mutate(Respondeu = if_else(respondeu, "Sim", "Não")) %>% 
    group_by(sg_partido) %>% 
    mutate(`Respondeu (%)` = n / sum(n) * 100, 
           sucesso = min(`Respondeu (%)`)) %>% 
    ggplot(aes(x = reorder(sg_partido, sucesso), 
               y = `Respondeu (%)`, 
               fill = Respondeu)) + 
    geom_col(position = "stack") + 
    coord_flip() + 
    labs(
        x = "",
        title = "Respostas por PARTIDO (em %)"
    ) + scale_fill_manual(values = cbPalette)

eleitos %>% 
    count(sg_partido, respondeu) %>% 
    mutate(Respondeu = if_else(respondeu, "Sim", "Não")) %>% 
    group_by(sg_partido) %>% 
    mutate(`Respondeu (%)` = n / sum(n) * 100, 
           sucesso =ifelse(respondeu == TRUE, min(`Respondeu (%)`), 0)) %>% 
    ggplot(aes(x = reorder(sg_partido, sucesso), 
               y = `Respondeu (%)`, 
               fill = Respondeu)) + 
    geom_col(position = "stack") + 
    coord_flip() + 
    labs(
        x = "",
        title = "Respostas dos eleitos por PARTIDO (em %)"
    ) + scale_fill_manual(values = cbPalette)

```

```{r}
dados %>% 
    count(sg_partido, respondeu) %>% 
    mutate(Respondeu = if_else(respondeu, "Sim", "Não")) %>% 
    mutate(countsim = ifelse(respondeu, n, 0)) %>% 
    ggplot(aes(x = reorder(sg_partido, countsim), y = n, fill = Respondeu)) + 
    geom_col(position = "stack") + 
    coord_flip() + 
    labs(
        x = "",
        title = "Respostas por PARTIDO (em absoluto)",
        y = "Quantidade de candidaturas"
    ) + scale_fill_manual(values = cbPalette)

 eleitos %>% 
    count(sg_partido, respondeu) %>%  
    mutate(countsim = ifelse(respondeu, n, 0)) %>% 
    mutate(Respondeu = if_else(respondeu, "Sim", "Não")) %>% 
    ggplot(aes(x = reorder(sg_partido, countsim), y = n, fill = Respondeu)) + 
    geom_col(position = "stack") + 
    coord_flip() + 
    labs(
        x = "",
        title = "Respostas dos eleitos por PARTIDO (em absoluto)",
        y = "Quantidade de candidaturas"
    ) + scale_fill_manual(values = cbPalette)
```

### Comparativo entre respostas de candidatos eleitos e não eleitos

```{r}

el <- eleitos %>% 
    count(respondeu) %>% 
    mutate(Respondeu = if_else(respondeu, "Sim", "Não")) %>% 
    mutate(`Respondeu (%)` = n / sum(n) * 100) 
 
el$fraction <- el$n/sum(el$n)
el = el[order(el$fraction), ]
el$ymax = cumsum(el$fraction)
el$ymin = c(0, head(el$ymax, n=-1)) 

 ggplot(el, aes(fill=Respondeu, ymax=ymax, ymin=ymin, xmax=4, xmin=3)) +
     geom_rect() +
     coord_polar(theta="y") +
     xlim(c(0, 4)) +
     theme(panel.grid=element_blank()) +
     theme(axis.text=element_blank()) +
     theme(axis.ticks=element_blank()) +
     annotate("text", x = 0, y = 0, label = "Eleitos que responderam") +
     labs(
        x = "",
        y = "") + scale_fill_manual(values = cbPalette)

nel <- dados %>% filter(eleito == FALSE) %>%  count(respondeu) %>% 
    mutate(Respondeu = if_else(respondeu, "Sim", "Não")) %>% 
    mutate(`Respondeu (%)` = n / sum(n) * 100) 
 
nel$fraction <- nel$n/sum(nel$n)
nel = nel[order(nel$fraction), ]
nel$ymax = cumsum(nel$fraction)
nel$ymin = c(0, head(nel$ymax, n=-1))

 ggplot(nel, aes(fill=Respondeu, ymax=ymax, ymin=ymin, xmax=4, xmin=3)) +
     geom_rect() +
     coord_polar(theta="y") +
     xlim(c(0, 4)) +
     theme(panel.grid=element_blank()) +
     theme(axis.text=element_blank()) +
     theme(axis.ticks=element_blank()) +
     annotate("text", x = 0, y = 0, label = "Não eleitos que responderam") +
     labs(
        x = "",
        y = "") + scale_fill_manual(values = cbPalette)
```

### Visão geral da aderência dos candidatos ao questionário

```{r fig.width=8}
dados %>% 
    filter(recebeu) %>%
    count(sg_partido, uf, respondeu) %>% 
    # complete(sg_partido, uf, respondeu, fill = list(n = 0)) %>% 
    group_by(sg_partido, uf) %>% 
    mutate(prop = n / sum(n), total_no_estado = sum(n)) %>%
    filter(respondeu) %>% 
    ggplot(aes(x = reorder(sg_partido, prop), y =reorder(uf, prop, median), color = prop*100, size = total_no_estado)) + 
    geom_point(alpha = .8) + 
    scale_color_viridis(option = "B", direction = -1) + 
    coord_flip() + 
    labs(x = "", y = "", color = "% responderam", size = "Candidatos")
```

# Analisando os dados gerados pelo Google Analytics

### Quantidade de usuários por região

![](/home/luizacs/Documentos/vozativa-relatorios/img/acessos-por-regiao.png)

### Quantidade de usuários (visão geral)

![](/home/luizacs/Documentos/vozativa-relatorios/img/usuarios.png)

### Quantidade de visualizações da página 

![](/home/luizacs/Documentos/vozativa-relatorios/img/visualizacoes-pag.png)

### Tempo de permanência na página

![](/home/luizacs/Documentos/vozativa-relatorios/img/tempo-permanencia.png)

### Canais de acesso

![](/home/luizacs/Documentos/vozativa-relatorios/img/canais.png)
![](/home/luizacs/Documentos/vozativa-relatorios/img/canais-barra.png)
<!-- ### Por partido e UF -->

```{r fig.height=9, fig.width=9}

# dados %>% 
#     count(sg_partido, uf, respondeu) %>% 
#     mutate(Respondeu = if_else(respondeu, "Sim", "Não")) %>% 
#     group_by(sg_partido) %>% 
#     mutate(
#         respondeu_partido = n / sum(n),
#         sucesso = min(respondeu_partido)) %>% 
#     group_by(sg_partido, uf) %>% 
#     mutate(`Respondeu (%)` = n / sum(n) * 100) %>% 
#     ggplot(aes(x = reorder(sg_partido, sucesso), 
#                y = `Respondeu (%)`, 
#                fill = Respondeu)) + 
#     geom_col(position = "stack") + 
#     coord_flip() + 
#     facet_grid(. ~uf) + 
#     labs(
#         x = "",
#         title = "Respostas por PARTIDO (em %)"
#     )
```

